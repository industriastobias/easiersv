<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Inventario</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: #fff;
        }
        th, td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #f2f2f2;
        }
        tr.selected {
            background-color: #c6e0b4;
        }
        input, select {
            padding: 8px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        button {
            padding: 8px 12px;
            margin-top: 10px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        .alert {
            padding: 10px;
            background-color: #f44336;
            color: white;
            margin: 10px 0;
            border-radius: 4px;
        }
        #noProductsMessage {
            color: red;
            display: none;
        }
    </style>
</head>
<body>

    <h1>Gestión de Inventario</h1>

    <input type="text" id="searchInput" placeholder="Buscar producto...">
    <input type="number" id="minPrice" placeholder="Precio mínimo">
    <input type="number" id="maxPrice" placeholder="Precio máximo">
    <select id="sortBy">
        <option value="default">Ordenar por</option>
        <option value="name">Nombre</option>
        <option value="priceAsc">Precio ascendente</option>
        <option value="priceDesc">Precio descendente</option>
        <option value="quantityAsc">Cantidad ascendente</option>
        <option value="quantityDesc">Cantidad descendente</option>
    </select>

    <div id="totalAmount"></div>
    <div id="totalCount"></div>
    <div id="noProductsMessage">No hay productos disponibles.</div>

    <table id="inventoryList">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Código</th>
                <th>Código de barras</th>
                <th>Precio</th>
                <th>Descuento</th>
                <th>Precio con descuento</th>
                <th>Descripción</th>
                <th>Categoría</th>
                <th>Cantidad</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button onclick="deleteAll()">Eliminar todos los productos</button>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const inventoryList = document.getElementById('inventoryList').getElementsByTagName('tbody')[0];
            const totalAmount = document.getElementById('totalAmount');
            const searchInput = document.getElementById('searchInput');
            const totalCount = document.getElementById('totalCount');
            const noProductsMessage = document.getElementById('noProductsMessage');
            const minPriceInput = document.getElementById('minPrice');
            const maxPriceInput = document.getElementById('maxPrice');
            const sortBySelect = document.getElementById('sortBy');

            let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
            let inventoryBackup = [...inventory]; // Guardamos una copia de seguridad

            // Cargar inventario desde localStorage
            function loadInventory(filteredInventory) {
                inventoryList.innerHTML = filteredInventory.map((item, index) => {
                    const priceWithDiscount = item.price - (item.price * (item.discount / 100));
                    return `
                        <tr data-index="${index}">
                            <td>${item.name}</td>
                            <td>${item.code}</td>
                            <td>${item.barcode}</td>
                            <td>${item.price}</td>
                            <td>${item.discount ? item.discount : 0}%</td>
                            <td>${priceWithDiscount.toFixed(2)}</td>
                            <td>${item.description}</td>
                            <td>${item.category}</td>
                            <td>${item.quantity}</td>
                            <td>
                                <button onclick="markAsSold(${index})">Marcar como Vendido</button>
                                <button class="delete" onclick="deleteItem(${index})">Eliminar</button>
                            </td>
                        </tr>
                    `;
                }).join('');

                const total = filteredInventory.reduce((sum, item) => {
                    const priceWithDiscount = item.price - (item.price * (item.discount / 100));
                    return sum + (priceWithDiscount * parseInt(item.quantity));
                }, 0);
                totalAmount.textContent = `$${total.toFixed(2)}`;

                const totalQuantity = filteredInventory.reduce((sum, item) => sum + parseInt(item.quantity), 0);
                if (totalQuantity === 0) {
                    noProductsMessage.style.display = 'block';
                } else {
                    noProductsMessage.style.display = 'none';
                }

                totalCount.textContent = `Número de productos disponibles: ${totalQuantity}`;
            }

            // Filtrar inventario según la búsqueda y filtros adicionales
            function filterInventory(query, minPrice, maxPrice) {
                return inventory.filter(item => {
                    const matchesQuery = item.name.toLowerCase().includes(query) || 
                                         item.code.toLowerCase().includes(query) || 
                                         item.category.toLowerCase().includes(query) || 
                                         item.barcode.toLowerCase().includes(query);
                    const matchesPrice = (minPrice ? item.price >= minPrice : true) && 
                                         (maxPrice ? item.price <= maxPrice : true);
                    return matchesQuery && matchesPrice;
                });
            }

            // Función para ordenar el inventario
            function sortInventory(filteredInventory, sortBy) {
                switch(sortBy) {
                    case 'name':
                        return filteredInventory.sort((a, b) => a.name.localeCompare(b.name));
                    case 'priceAsc':
                        return filteredInventory.sort((a, b) => a.price - b.price);
                    case 'priceDesc':
                        return filteredInventory.sort((a, b) => b.price - a.price);
                    case 'quantityAsc':
                        return filteredInventory.sort((a, b) => a.quantity - b.quantity);
                    case 'quantityDesc':
                        return filteredInventory.sort((a, b) => b.quantity - a.quantity);
                    default:
                        return filteredInventory;
                }
            }

            // Función para marcar un producto como vendido
            window.markAsSold = function(index) {
                let soldItems = JSON.parse(localStorage.getItem('soldItems')) || [];
                const item = inventory[index];

                const quantityToSell = prompt(`¿Cuántas unidades de "${item.name}" deseas vender? (Disponibles: ${item.quantity})`);
                if (quantityToSell === null || quantityToSell.trim() === "") {
                    alert("Operación cancelada o cantidad no válida.");
                    return;
                }

                const quantity = parseInt(quantityToSell);
                if (isNaN(quantity) || quantity <= 0) {
                    alert("Por favor, ingresa un número válido mayor que 0.");
                    return;
                }

                if (quantity > item.quantity) {
                    alert("No hay suficiente stock para realizar la venta.");
                    return;
                }

                // Resta la cantidad del inventario
                item.quantity -= quantity;
                if (item.quantity <= 0) {
                    inventory.splice(index, 1); // Elimina el producto si la cantidad llega a 0
                }

                // Guarda los productos vendidos solo si el producto sigue en el inventario
                const soldItem = { ...item, quantitySold: quantity };
                soldItems.push(soldItem);

                // Solo actualizamos localStorage cuando sea necesario
                localStorage.setItem('soldItems', JSON.stringify(soldItems));

                // Actualiza la interfaz sin recargar todo el inventario
                updateInventoryRow(index);

                alert(`Se ha vendido ${quantity} unidades de "${item.name}".`);
            };

            // Actualiza una fila específica del inventario
            function updateInventoryRow(index) {
                const row = inventoryList.querySelector(`tr[data-index="${index}"]`);
                const item = inventory[index];
                const priceWithDiscount = item.price - (item.price * (item.discount / 100));

                // Actualiza los valores de la fila correspondiente
                row.querySelector('td:nth-child(9)').textContent = item.quantity;
                row.querySelector('td:nth-child(6)').textContent = priceWithDiscount.toFixed(2);
            }

            // Función para eliminar un producto
            window.deleteItem = function(index) {
                if (confirm("¿Estás seguro de que deseas eliminar este producto?")) {
                    inventory.splice(index, 1);
                    localStorage.setItem('inventory', JSON.stringify(inventory));
                    loadInventory(filterInventory(searchInput.value.toLowerCase(), minPriceInput.value, maxPriceInput.value));
                }
            };

            // Función para eliminar todos los productos
            window.deleteAll = function() {
                if (confirm("¿Estás seguro de que deseas eliminar todos los productos?")) {
                    inventory = [];
                    localStorage.setItem('inventory', JSON.stringify(inventory));
                    loadInventory([]);
                }
            };

            // Debounce para la búsqueda
            let debounceTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(function() {
                    const query = searchInput.value.toLowerCase();
                    const filteredInventory = filterInventory(query, minPriceInput.value, maxPriceInput.value);
                    const sortedInventory = sortInventory(filteredInventory, sortBySelect.value);
                    loadInventory(sortedInventory);
                }, 300); // 300ms de retraso
            });

            // Filtrar y ordenar inventario al cambiar los filtros
            minPriceInput.addEventListener('input', updateFilters);
            maxPriceInput.addEventListener('input', updateFilters);
            sortBySelect.addEventListener('change', updateFilters);

            // Actualizar filtros
            function updateFilters() {
                const query = searchInput.value.toLowerCase();
                const filteredInventory = filterInventory(query, minPriceInput.value, maxPriceInput.value);
                const sortedInventory = sortInventory(filteredInventory, sortBySelect.value);
                loadInventory(sortedInventory);
            }

            // Cargar inventario al inicio
            loadInventory(inventory);
        });
    </script>

</body>
</html>
