<script>
    /* ---------- ESTADO ---------- */
    let clientes = JSON.parse(localStorage.getItem('clientes')) || [];
    let clienteAEliminar = null;
    let modoEdicion = false;
    let clienteEnEdicion = null;

    /* ---------- REFERENCIAS ---------- */
    const form = document.getElementById('cliente-form');
    const tablaClientes = document.getElementById('tabla-clientes');
    const searchInput = document.getElementById('search');
    const emptyState = document.getElementById('empty-state');
    const btnCancel = document.getElementById('btn-cancel');
    const formTitle = document.getElementById('form-title');
    const btnSubmitText = document.getElementById('btn-submit-text');

    /* ---------- INICIO ---------- */
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Clientes encontrados:', clientes); // ← VERIFICA EN CONSOLA
        mostrarClientes();
        actualizarEstadisticas();
        form.addEventListener('submit', manejarSubmit);
        searchInput.addEventListener('input', buscarCliente);
        btnCancel.addEventListener('click', cancelarEdicion);
    });

    /* ---------- LÓGICA ---------- */
    function manejarSubmit(e) {
        e.preventDefault();
        modoEdicion ? actualizarCliente() : registrarCliente();
    }

    function registrarCliente() {
        const c = obtenerDatosFormulario();
        if (!c) return;
        if (clientes.some(x => x.id === c.id)) return mostrarToast('ID duplicado', 'error');
        if (clientes.some(x => x.numeroTarjeta === c.numeroTarjeta)) return mostrarToast('Tarjeta duplicada', 'error');
        clientes.push(c);
        guardarClientes();
        mostrarClientes();
        actualizarEstadisticas();
        form.reset();
        mostrarToast('Cliente registrado', 'success');
    }

    function actualizarCliente() {
        const c = obtenerDatosFormulario();
        if (!c || !clienteEnEdicion) return;
        const idx = clientes.findIndex(x => x.id === clienteEnEdicion.id);
        if (idx === -1) return mostrarToast('Cliente no encontrado', 'error');
        if (clientes.some(x => x.id === c.id && x.id !== clienteEnEdicion.id)) return mostrarToast('ID duplicado', 'error');
        if (clientes.some(x => x.numeroTarjeta === c.numeroTarjeta && x.id !== clienteEnEdicion.id)) return mostrarToast('Tarjeta duplicada', 'error');
        clientes[idx] = c;
        guardarClientes();
        mostrarClientes();
        actualizarEstadisticas();
        cancelarEdicion();
        mostrarToast('Cliente actualizado', 'success');
    }

    function obtenerDatosFormulario() {
        const id = document.getElementById('id').value.trim();
        const nombre = document.getElementById('nombre').value.trim();
        const correo = document.getElementById('correo').value.trim();
        const telefono = document.getElementById('telefono').value.trim();
        const numeroTarjeta = document.getElementById('numero-tarjeta').value.trim();
        const monto = parseFloat(document.getElementById('monto').value) || 0;
        const estadoTarjeta = document.getElementById('estado-tarjeta').value;
        const puntos = parseInt(document.getElementById('puntos').value) || 0;
        if (!id || !nombre || !correo || !telefono || !numeroTarjeta) {
            mostrarToast('Completa todos los campos obligatorios', 'error');
            return null;
        }
        return { id, nombre, correo, telefono, numeroTarjeta, monto, estadoTarjeta, puntos };
    }

    function editarCliente(id) {
        const c = clientes.find(x => x.id === id);
        if (!c) return mostrarToast('Cliente no encontrado', 'error');
        modoEdicion = true;
        clienteEnEdicion = c;
        document.getElementById('id').value = c.id;
        document.getElementById('nombre').value = c.nombre;
        document.getElementById('correo').value = c.correo;
        document.getElementById('telefono').value = c.telefono;
        document.getElementById('numero-tarjeta').value = c.numeroTarjeta;
        document.getElementById('monto').value = c.monto;
        document.getElementById('estado-tarjeta').value = c.estadoTarjeta;
        document.getElementById('puntos').value = c.puntos;
        formTitle.textContent = 'Editar Cliente';
        btnSubmitText.textContent = 'Actualizar Cliente';
        btnCancel.style.display = 'inline-flex';
        form.scrollIntoView({ behavior: 'smooth' });
    }

    function cancelarEdicion() {
        modoEdicion = false;
        clienteEnEdicion = null;
        form.reset();
        formTitle.textContent = 'Nuevo Cliente';
        btnSubmitText.textContent = 'Guardar Cliente';
        btnCancel.style.display = 'none';
    }

    function eliminarCliente(id) {
        clienteAEliminar = id;
        document.getElementById('confirm-modal').style.display = 'block';
    }

    function confirmarEliminacion() {
        if (!clienteAEliminar) return;
        clientes = clientes.filter(x => x.id !== clienteAEliminar);
        guardarClientes();
        mostrarClientes();
        actualizarEstadisticas();
        cerrarModal();
        mostrarToast('Cliente eliminado', 'success');
        clienteAEliminar = null;
    }

    function cerrarModal() {
        document.getElementById('confirm-modal').style.display = 'none';
        clienteAEliminar = null;
    }

    function buscarCliente() {
        const q = searchInput.value.trim().toLowerCase();
        const filtrados = clientes.filter(c =>
            c.id.toLowerCase() === q ||
            c.correo.toLowerCase() === q ||
            c.telefono === q ||
            c.nombre.toLowerCase().includes(q) ||
            c.numeroTarjeta.toLowerCase().includes(q)
        );
        renderizarTabla(filtrados);
    }

    function mostrarClientes() {
        renderizarTabla(clientes);
    }

    function renderizarTabla(datos) {
        tablaClientes.innerHTML = '';
        emptyState.style.display = datos.length ? 'none' : 'block';
        datos.forEach(c => {
            const fila = document.createElement('tr');
            fila.innerHTML = `
                <td>${c.id}</td>
                <td>${c.nombre}</td>
                <td>${c.correo}</td>
                <td>${c.telefono}</td>
                <td>${c.numeroTarjeta}</td>
                <td>$${c.monto.toFixed(2)}</td>
                <td>
                    <span class="status-badge ${c.estadoTarjeta === 'activo' ? 'status-active' : 'status-inactive'}">
                        ${c.estadoTarjeta === 'activo' ? 'Activo' : 'Inactivo'}
                    </span>
                </td>
                <td>${c.puntos.toLocaleString()}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="editarCliente('${c.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarCliente('${c.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tablaClientes.appendChild(fila);
        });
    }

    function actualizarEstadisticas() {
        document.getElementById('total-clientes').textContent = clientes.length.toLocaleString();
        document.getElementById('total-activos').textContent = clientes.filter(c => c.estadoTarjeta === 'activo').length.toLocaleString();
        document.getElementById('total-puntos').textContent = clientes.reduce((s, c) => s + c.puntos, 0).toLocaleString();
    }

    function exportarDatos() {
        if (!clientes.length) return mostrarToast('No hay datos', 'error');
        const csv = [
            ['ID', 'Nombre', 'Correo', 'Teléfono', 'Tarjeta', 'Monto', 'Estado', 'Puntos'],
            ...clientes.map(c => [c.id, c.nombre, c.correo, c.telefono, c.numeroTarjeta, c.monto, c.estadoTarjeta, c.puntos])
        ].map(f => f.join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'clientes.csv';
        a.click();
        URL.revokeObjectURL(url);
        mostrarToast('Exportado', 'success');
    }

    function guardarClientes() {
        localStorage.setItem('clientes', JSON.stringify(clientes));
    }

    function mostrarToast(msg, tipo = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.className = 'toast ' + (tipo === 'error' ? 'error' : '');
        toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', 3000);
    }

    window.onclick = e => {
        if (e.target === document.getElementById('confirm-modal')) cerrarModal();
    };
</script>
